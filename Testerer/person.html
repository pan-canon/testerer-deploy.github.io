<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º COCO-SSD –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π —Ä–∞–º–æ–∫</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
  <style>
    #videoContainer {
      width: 640px;
      height: 480px;
      background: #000;
      position: relative;
    }
    /* –≠–ª–µ–º–µ–Ω—Ç overlay –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
    #overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 16px;
      pointer-events: none;
      z-index: 2;
    }
    /* –≠–ª–µ–º–µ–Ω—Ç canvas –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ bounding box */
    #canvasOverlay {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
  </style>
</head>
<body>
  <h1>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∫–∞–º–µ—Ä–æ–π –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π –∫–æ–Ω—Ç—É—Ä–∞</h1>
  <div id="videoContainer">
    <div id="overlay"></div>
    <!-- canvas –±—É–¥–µ—Ç —Ä–∞—Å–ø–æ–ª–∞–≥–∞—Ç—å—Å—è –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ -->
    <canvas id="canvasOverlay"></canvas>
  </div>
  <button id="startButton">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
  <button id="stopButton">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É</button>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      class cameraSectionManager {
        constructor() {
          this.videoElement = null;
          this.stream = null;
          this.onVideoReady = null;
          this.onCameraClosed = null;
          this.model = null;
          this.isDetecting = false;
          this.onObjectDetected = null;
          this.canvas = document.getElementById("canvasOverlay");
          this.ctx = this.canvas.getContext("2d");
        }

        attachTo(containerId, options = {}) {
          const container = document.getElementById(containerId);
          if (!container) {
            console.error(`–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å id "${containerId}" –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
            return;
          }
          if (!this.videoElement) {
            this.videoElement = document.createElement('video');
            this.videoElement.autoplay = true;
            this.videoElement.playsInline = true;
          } else if (this.videoElement.parentNode) {
            this.videoElement.parentNode.removeChild(this.videoElement);
          }
          for (const prop in options) {
            this.videoElement.style[prop] = options[prop];
          }
          container.innerHTML = "";
          container.appendChild(this.videoElement);
          // –ü–æ–º–µ—â–∞–µ–º canvas –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ
          container.appendChild(this.canvas);
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–∞–∑–º–µ—Ä–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          this.canvas.width = container.clientWidth;
          this.canvas.height = container.clientHeight;
        }

        async startCamera() {
          if (this.stream) {
            console.log("–ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞");
            return;
          }
          try {
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            const constraints = { video: { facingMode: isMobile ? "environment" : "user" } };
            console.log(`üé• –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —Å —Ä–µ–∂–∏–º–æ–º: ${constraints.video.facingMode}`);
            this.stream = await navigator.mediaDevices.getUserMedia(constraints);
            if (!this.videoElement) {
              console.error("Video —ç–ª–µ–º–µ–Ω—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω!");
              return;
            }
            this.videoElement.srcObject = this.stream;
            this.videoElement.addEventListener("loadedmetadata", async () => {
              console.log("loadedmetadata: –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ");
              if (typeof this.onVideoReady === "function") {
                this.onVideoReady();
              }
              await this.loadModel();
              this.startDetection();
              const event = new CustomEvent("cameraReady");
              document.dispatchEvent(event);
            }, { once: true });
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", error);
          }
        }

        stopCamera() {
          if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
            this.stream = null;
            if (typeof this.onCameraClosed === "function") {
              this.onCameraClosed();
            }
          }
          this.isDetecting = false;
          // –û—á–∏—Å—Ç–∫–∞ canvas
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        }

        async loadModel() {
          if (!this.model) {
            console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ COCO-SSD...");
            try {
              this.model = await cocoSsd.load();
              console.log("–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            } catch (error) {
              console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:", error);
            }
          }
        }

        startDetection() {
          if (!this.model) {
            console.error("–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ loadModel() –ø–µ—Ä–µ–¥ startDetection().");
            return;
          }
          this.isDetecting = true;
          const detectFrame = async () => {
            if (!this.isDetecting) return;
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞: –æ—á–∏—â–∞–µ–º canvas
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            const predictions = await this.model.detect(this.videoElement);
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
            if (predictions && predictions.length > 0) {
              predictions.forEach(prediction => {
                // –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –≤ overlay
                if (prediction.class === "person") {
                  // –†–∏—Å—É–µ–º –ø—É–Ω–∫—Ç–∏—Ä–Ω—É—é —Ä–∞–º–∫—É
                  this.drawBoundingBox(prediction.bbox, "red");
                }
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å callback
                if (typeof this.onObjectDetected === "function") {
                  this.onObjectDetected(prediction);
                }
              });
            }
            requestAnimationFrame(detectFrame);
          };
          detectFrame();
        }

        drawBoundingBox(bbox, color = "red") {
          const [x, y, width, height] = bbox;
          this.ctx.lineWidth = 2;
          this.ctx.strokeStyle = color;
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É–Ω–∫—Ç–∏—Ä–Ω—É—é –ª–∏–Ω–∏—é
          this.ctx.setLineDash([5, 5]);
          this.ctx.strokeRect(x, y, width, height);
          // –°–±—Ä–æ—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ dash, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–µ–∑ –Ω–µ–≥–æ
          this.ctx.setLineDash([]);
        }
      }

      const cameraManager = new cameraSectionManager();
      cameraManager.attachTo("videoContainer", { width: "640px", height: "480px" });

      // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç overlay –¥–ª—è —Ç–µ–∫—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      const overlay = document.getElementById("overlay");
      cameraManager.onObjectDetected = (detectedObject) => {
        if (overlay) {
          overlay.innerHTML = `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: ${detectedObject.class}`;
        }
      };

      document.getElementById("startButton").addEventListener("click", () => {
        cameraManager.startCamera();
      });
      document.getElementById("stopButton").addEventListener("click", () => {
        cameraManager.stopCamera();
        if (overlay) {
          overlay.innerHTML = "";
        }
      });
    });
  </script>
</body>
</html>