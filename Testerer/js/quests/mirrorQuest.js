import { BaseQuest } from './baseQuest.js';

export class MirrorQuest extends BaseQuest {
  /**
   * @param {EventManager} eventManager ‚Äì –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–±—ã—Ç–∏–π
   * @param {App} appInstance ‚Äì —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç App –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ —Ç.–¥.
   */
  constructor(eventManager, appInstance) {
    super(eventManager);
    this.app = appInstance;
    this.key = "mirror_quest";
    this.doneKey = "mirror_done";
    
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –∫–≤–µ—Å—Ç–µ
    this.registerEvents();
  }

  registerEvents() {
    // –ü—Ä–∏–º–µ—Ä: –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
    const cameraBtn = document.getElementById("toggle-camera");
    if (cameraBtn) {
      cameraBtn.addEventListener("click", async () => {
        // –ï—Å–ª–∏ —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–µ–Ω ‚Äì –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–≤–µ—Å—Ç–∞
        if (localStorage.getItem("mirrorQuestActive") === "true") {
          console.log("ü™û –ó–∞–ø—É—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–µ—Ä–∫–∞–ª—å–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏");
          await this.finish();
        }
      });
    }
  }

  async checkStatus() {
    console.log("ü™û Mirror quest –∞–∫—Ç–∏–≤–Ω–æ. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É...");
    return new Promise(resolve => {
      setTimeout(async () => {
        console.log("‚è± –ó–∞–ø—É—Å–∫ compareCurrentFrame() —á–µ—Ä–µ–∑ 3 —Å–µ–∫...");
        const success = await this.app.compareCurrentFrame();
        console.log("‚è± –†–µ–∑—É–ª—å—Ç–∞—Ç compareCurrentFrame():", success);
        resolve(success);
      }, 3000);
    });
  }

  async finish() {
    // –ï—Å–ª–∏ –∫–≤–µ—Å—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Äì –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if (this.eventManager.isEventLogged(this.doneKey)) {
      console.log(`Quest "${this.key}" —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.`);
      return;
    }

    const success = await this.checkStatus();
    if (success) {
      if (!this.eventManager.isEventLogged(this.doneKey)) {
        await this.eventManager.addDiaryEntry(this.doneKey);
        await this.eventManager.addDiaryEntry("what_was_it", this.app.lastMirrorPhoto);
      }
      // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å —Å–≤–µ—á–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∫–≤–µ—Å—Ç–∞
      const cameraBtn = document.getElementById("toggle-camera");
      if (cameraBtn) {
        cameraBtn.classList.remove("glowing");
      }
      localStorage.removeItem("mirrorQuestActive");

      alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ ¬´–ø–æ–¥–æ–π—Ç–∏ –∫ –∑–µ—Ä–∫–∞–ª—É¬ª –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!");
    } else {
      alert("‚ùå –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!");
    }
  }
}
