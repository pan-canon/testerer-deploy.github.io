<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º COCO-SSD</title>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º TensorFlow.js –∏ –º–æ–¥–µ–ª—å COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
  <style>
    #videoContainer {
      width: 640px;
      height: 480px;
      background: #000;
      position: relative;
    }
  </style>
</head>
<body>
  <h1>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∫–∞–º–µ—Ä–æ–π</h1>
  <div id="videoContainer"></div>
  <button id="startButton">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
  <button id="stopButton">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É</button>

  <script>
    // –ö–ª–∞—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–æ–π —Å –¥–µ—Ç–µ–∫—Ü–∏–µ–π –æ–±—ä–µ–∫—Ç–æ–≤
    class cameraSectionManager {
      constructor() {
        this.videoElement = null;
        this.stream = null;
        this.onVideoReady = null;
        this.onCameraClosed = null;
        // –°–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤
        this.model = null;
        this.isDetecting = false;
        this.onObjectDetected = null;
      }

      /**
       * –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç video-—ç–ª–µ–º–µ–Ω—Ç –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É.
       * @param {string} containerId - ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
       * @param {object} options - CSS —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ.
       */
      attachTo(containerId, options = {}) {
        const container = document.getElementById(containerId);
        if (!container) {
          console.error(`–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å id "${containerId}" –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
          return;
        }
        if (!this.videoElement) {
          this.videoElement = document.createElement('video');
          this.videoElement.autoplay = true;
          this.videoElement.playsInline = true;
        } else if (this.videoElement.parentNode) {
          this.videoElement.parentNode.removeChild(this.videoElement);
        }
        for (const prop in options) {
          this.videoElement.style[prop] = options[prop];
        }
        container.innerHTML = "";
        container.appendChild(this.videoElement);
      }

      /**
       * –ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–∞–º–µ—Ä—É –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫ –≤ videoElement.
       */
      async startCamera() {
        if (this.stream) {
          console.log("–ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞");
          return;
        }
        try {
          const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
          const constraints = { video: { facingMode: isMobile ? "environment" : "user" } };
          console.log(`üé• –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —Å —Ä–µ–∂–∏–º–æ–º: ${constraints.video.facingMode}`);
          this.stream = await navigator.mediaDevices.getUserMedia(constraints);
          if (!this.videoElement) {
            console.error("Video —ç–ª–µ–º–µ–Ω—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω!");
            return;
          }
          this.videoElement.srcObject = this.stream;
          this.videoElement.addEventListener("loadedmetadata", async () => {
            console.log("loadedmetadata: –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ");
            if (typeof this.onVideoReady === "function") {
              this.onVideoReady();
            }
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –ø–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –≤–∏–¥–µ–æ
            await this.loadModel();
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤
            this.startDetection();
            const event = new CustomEvent("cameraReady");
            document.dispatchEvent(event);
          }, { once: true });
        } catch (error) {
          console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", error);
        }
      }

      /**
       * –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É –∏ —Ü–∏–∫–ª –¥–µ—Ç–µ–∫—Ü–∏–∏.
       */
      stopCamera() {
        if (this.stream) {
          this.stream.getTracks().forEach(track => track.stop());
          this.stream = null;
          if (typeof this.onCameraClosed === "function") {
            this.onCameraClosed();
          }
        }
        this.isDetecting = false;
      }

      /**
       * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å COCO-SSD.
       */
      async loadModel() {
        if (!this.model) {
          console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ COCO-SSD...");
          try {
            this.model = await cocoSsd.load();
            console.log("–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
          } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:", error);
          }
        }
      }

      /**
       * –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤.
       */
      startDetection() {
        if (!this.model) {
          console.error("–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ loadModel() –ø–µ—Ä–µ–¥ startDetection().");
          return;
        }
        this.isDetecting = true;
        const detectFrame = async () => {
          if (!this.isDetecting) return;
          const predictions = await this.model.detect(this.videoElement);
          if (predictions && predictions.length > 0) {
            const detectedObject = predictions[0];
            console.log("–û–±—ä–µ–∫—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω:", detectedObject);
            if (typeof this.onObjectDetected === "function") {
              this.onObjectDetected(detectedObject);
            }
          }
          requestAnimationFrame(detectFrame);
        };
        detectFrame();
      }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const cameraManager = new cameraSectionManager();
    cameraManager.attachTo("videoContainer", { width: "640px", height: "480px" });

    // Callback, –≤—ã–∑—ã–≤–∞–µ–º—ã–π –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞
    cameraManager.onObjectDetected = (detectedObject) => {
      console.log("Callback –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞:", detectedObject);
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Ä–∞–º–æ–∫)
    };

    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–æ–π
    document.getElementById("startButton").addEventListener("click", () => {
      cameraManager.startCamera();
    });
    document.getElementById("stopButton").addEventListener("click", () => {
      cameraManager.stopCamera();
    });
  </script>
</body>
</html>