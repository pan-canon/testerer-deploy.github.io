<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face-api.js Example</title>
  <!-- Подключаем face-api.js из локальной папки -->
  <script src="js/libs/face-api.js"></script>
</head>
<body>
  <h1>Face-api.js Example</h1>
  <button id="capture">Capture Selfie</button>
  <button id="compare">Compare with Camera</button>
  <video id="video" width="640" height="480" autoplay></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <script>
    let videoElement = document.getElementById("video");
    let captureButton = document.getElementById("capture");
    let compareButton = document.getElementById("compare");
    let selfieImage = null; // Для хранения селфи

    // Инициализация камеры
    async function setupCamera() {
      console.log("Setting up camera...");
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      videoElement.srcObject = stream;
      await new Promise(resolve => videoElement.onplaying = resolve);
      console.log("Camera ready");
    }

    // Загружаем модели
    async function loadModels() {
      console.log("Loading models...");
      await Promise.all([
        faceapi.nets.ssdMobilenetv1.loadFromUri('/models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
        faceapi.nets.faceRecognitionNet.loadFromUri('/models')
      ]);
      console.log("Models loaded");
    }

    // Загружаем камеру и модели
    async function init() {
      await setupCamera();
      await loadModels();
    }

    // Селфи: захват кадра с камеры и сохранение в формате base64
    captureButton.addEventListener("click", async () => {
      console.log("Capturing selfie...");
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
      selfieImage = canvas.toDataURL();
      console.log("Selfie captured:", selfieImage);
    });

    // Сравнение селфи с текущим кадром
    compareButton.addEventListener("click", async () => {
      if (!selfieImage) {
        console.log("No selfie captured to compare with.");
        return;
      }

      console.log("Comparing selfie with live camera feed...");
      const faceMatcher = new faceapi.FaceMatcher(await detectFace(selfieImage));
      const liveFace = await detectFace(videoElement);

      const distance = faceMatcher.computeBestMatch(liveFace[0].descriptor);
      console.log("Face similarity:", distance.toString());
      if (distance.distance < 0.6) {
        console.log("Faces match!");
      } else {
        console.log("Faces do not match.");
      }
    });

    // Функция для обнаружения лица
    async function detectFace(imageData) {
      const img = await faceapi.bufferToImage(imageData);
      const detections = await faceapi.detectAllFaces(img)
        .withFaceLandmarks()
        .withFaceDescriptors();
      return detections;
    }

    // Запускаем инициализацию
    init();
  </script>
</body>
</html>
