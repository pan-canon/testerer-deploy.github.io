export class BaseMirrorQuest {
  /**
   * –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∫–≤–µ—Å—Ç–∞ —Å –∑–µ—Ä–∫–∞–ª–æ–º –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è–º–∏.
   * @param {EventManager} eventManager ‚Äì –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–Ω–µ–≤–Ω–∏–∫–æ–º
   * @param {App} appInstance ‚Äì —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
   */
  constructor(eventManager, appInstance) {
    this.eventManager = eventManager;
    this.app = appInstance;
    this.key = "mirror_quest"; // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
    this.doneKey = "mirror_done"; // –∫–ª—é—á –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
    this.registerEvents(); // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Å –∫–∞–º–µ—Ä–∞–º–∏
  }

  /**
   * –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
   */
  registerEvents() {
  }

  /**
   * –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ –Ω–µ –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.
   */
async activate() {
  if (!this.eventManager.isEventLogged(this.key)) {
    console.log(`–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ: ${this.key}`);
    await this.eventManager.addDiaryEntry(this.key);
  }
  console.log("–ó–µ—Ä–∫–∞–ª—å–Ω—ã–π –∫–≤–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏.");
  // –î–æ–±–∞–≤–ª—è–µ–º (–Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º) –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞—Ç–µ–º –ø–ª–∞–Ω–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    this.finish();
  }, 5000);
}





  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ–∫—É—â–µ–≥–æ –∑–µ—Ä–∫–∞–ª—å–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞.
   */
async checkStatus() {
  console.log("ü™û –ó–µ—Ä–∫–∞–ª—å–Ω—ã–π –∫–≤–µ—Å—Ç –∞–∫—Ç–∏–≤–Ω–æ. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É...");
  return new Promise(resolve => {
    setTimeout(async () => {
      console.log("‚è± –ó–∞–ø—É—Å–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞...");
      const success = await this.app.compareCurrentFrame();
      console.log("‚è± –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:", success);
      resolve(success);
    }, 5000);
  });
}


  /**
   * –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –¥–Ω–µ–≤–Ω–∏–∫).
   */
async finish() {
  // –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –∫–≤–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞)
  const success = await this.checkStatus();
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏–∑—Ä–∞–∫–∞ –∏ –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –±—É–∫–≤—É –∏–∑ –µ–≥–æ –∏–º–µ–Ω–∏
  const ghost = this.app.ghostManager.getCurrentGhost();
  const randomLetter = this.getRandomLetter(ghost.name);
  
  if (success) {
    // –ï—Å–ª–∏ –∫–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Äì –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) —Ñ–æ—Ç–æ
    const photoData = this.app.lastMirrorPhoto ? ` [photo attached]\n${this.app.lastMirrorPhoto}` : "";
    await this.eventManager.addDiaryEntry(`user_post_success: ${randomLetter}${photoData}`, false);
    alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ ¬´–ø–æ–¥–æ–π—Ç–∏ –∫ –∑–µ—Ä–∫–∞–ª—É¬ª –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!");
  } else {
    // –ï—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Äì –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç —Å –Ω–µ—É—Å–ø–µ—Ö–æ–º
    await this.eventManager.addDiaryEntry(`user_post_failed: ${randomLetter}`, false);
    alert("‚ùå –ö–≤–µ—Å—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω!");
  }
  
  // –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –æ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è) –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø–æ—Å—Ç–∏—Ç—å"
  localStorage.removeItem("mirrorQuestActive");
  this.app.updatePostButtonState();
  
  // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å —Ç–µ–Ω–∏ —Å –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã
  const cameraBtn = document.getElementById("toggle-camera");
  if (cameraBtn) {
    cameraBtn.classList.remove("glowing");
  }
  
  // –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –¥–∞–ª—å–Ω–µ–π—à–µ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç ‚Äì –Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ –Ω–∞–∂–∞—Ç–∏—é "–ó–∞–ø–æ—Å—Ç–∏—Ç—å"
}






getRandomLetter(name) {
  // –û—Å—Ç–∞–≤–ª—è–µ–º –≤ —Å—Ç—Ä–æ–∫–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã (–ª–∞—Ç–∏–Ω—Å–∫–∏–µ –∏ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ) –∏ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã/—Ü–∏—Ñ—Ä—ã
  const letters = name.replace(/[^A-Za-z–ê-–Ø–∞-—è–Å—ë]/g, '').split('');
  if (letters.length === 0) return '';
  const randomIndex = Math.floor(Math.random() * letters.length);
  return letters[randomIndex];
}
}