import { BaseEvent } from '../events/baseEvent.js';

/**
 * BaseMirrorQuest ‚Äì –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∑–µ—Ä–∫–∞–ª—å–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞.
 *
 * –≠—Ç–æ—Ç –∫–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ–±—â—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –∫–≤–µ—Å—Ç–∞ —Å –∑–µ—Ä–∫–∞–ª–æ–º:
 * - –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–≤–µ—Å—Ç–∞ (–∑–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏).
 * - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–≤–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞.
 * - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—É—Å–ø–µ—Ö/–Ω–µ—É–¥–∞—á–∞) –≤ –¥–Ω–µ–≤–Ω–∏–∫, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
 *
 * –ö–ª–∞—Å—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å EventManager –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π –∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (App)
 * –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º, —Ç–∞–∫–∏–º –∫–∞–∫ compareCurrentFrame() –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏.
 */
export class BaseMirrorQuest {
  /**
   * –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä BaseMirrorQuest.
   * @param {EventManager} eventManager - –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–±—ã—Ç–∏–π, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ —Ä–∞–±–æ—Ç—É —Å –¥–Ω–µ–≤–Ω–∏–∫–æ–º.
   * @param {App} appInstance - –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –∫–∞–º–µ—Ä—ã –∏ –¥—Ä—É–≥–∏–º –º–æ–¥—É–ª—è–º.
   */
  constructor(eventManager, appInstance) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–±—ã—Ç–∏–π.
    this.eventManager = eventManager;
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
    this.app = appInstance;
    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∫–≤–µ—Å—Ç–∞ —Å –∑–µ—Ä–∫–∞–ª–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ.
    this.key = "mirror_quest";
    // –ö–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–≤–µ—Å—Ç–∞.
    this.doneKey = "mirror_done";

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ –±—É–¥—É—â–µ–º).
    // –°–µ–π—á–∞—Å –º–µ—Ç–æ–¥ registerEvents() –ø—É—Å—Ç, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω.
    this.registerEvents();
  }

  /**
   * registerEvents ‚Äì —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
   * –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç–æ–¥ –æ—Å—Ç–∞–≤–ª–µ–Ω –ø—É—Å—Ç—ã–º, –Ω–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.
   */
  registerEvents() {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è,
    // –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ —ç–∫—Ä–∞–Ω–∞ –∫–≤–µ—Å—Ç–∞.
  }

  /**
   * activate ‚Äì –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π –∫–≤–µ—Å—Ç.
   *
   * –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —Å –∫–ª—é—á–æ–º mirror_quest –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ,
   * –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º. –ó–∞—Ç–µ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–≤–µ—Å—Ç–∞
   * (mirrorQuestActive) –≤ localStorage –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç.
   *
   * @returns {Promise<void>} –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞.
   */
  async activate() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –ª–∏ —É–∂–µ —Å–æ–±—ã—Ç–∏–µ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ.
    if (!this.eventManager.isEventLogged(this.key)) {
      console.log(`–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ: ${this.key}`);
      await this.eventManager.addDiaryEntry(this.key);
    }
    console.log("–ó–µ—Ä–∫–∞–ª—å–Ω—ã–π –∫–≤–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏.");
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, –∫–æ—Ç–æ—Ä—ã–π —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ —Ç–æ–º, —á—Ç–æ –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π –∫–≤–µ—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω.
    localStorage.setItem("mirrorQuestActive", "true");
  }

  /**
   * checkStatus ‚Äì –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–µ—Ä–∫–∞–ª—å–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞.
   *
   * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –∂–¥–µ—Ç 5 —Å–µ–∫—É–Ω–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–∞–≤–∞—è –≤—Ä–µ–º—è –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É),
   * –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Å–µ–ª—Ñ–∏ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ compareCurrentFrame().
   *
   * @returns {Promise<boolean>} –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: true, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –∏–Ω–∞—á–µ false.
   */
  async checkStatus() {
    console.log("ü™û –ó–µ—Ä–∫–∞–ª—å–Ω—ã–π –∫–≤–µ—Å—Ç –∞–∫—Ç–∏–≤–Ω–æ. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É...");
    console.log("‚è± –ó–∞–ø—É—Å–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞ (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏)...");
    const success = await this.app.compareCurrentFrame();
    console.log("‚è± –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:", success);
    return success;
  }

// –í–Ω—É—Ç—Ä–∏ QuestManager
handleShootMirrorQuest() {
  // –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π –∫–≤–µ—Å—Ç
  this.checkQuest("mirror_quest")
    .then(() => {
      // –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–≤–µ—Å—Ç–∞ ‚Äì —É–±–∏—Ä–∞–µ–º UI
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –∏–¥—ë—Ç
      clearInterval(this.app.mirrorCheckInterval);
      this.app.mirrorCheckInterval = null;

      // –ü—Ä—è—á–µ–º —Å—Ç–∞—Ç—É—Å
      const statusDiv = document.getElementById("camera-status");
      if (statusDiv) {
        statusDiv.style.display = "none";
      }

      // –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É
      const shootBtn = document.getElementById("btn_shoot");
      if (shootBtn) {
        shootBtn.style.display = "none";
      }
    })
    .catch(err => console.error(err));
}


  /**
   * finish ‚Äì –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π –∫–≤–µ—Å—Ç.
   *
   * –ú–µ—Ç–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
   * 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–≤–µ—Å—Ç–∞ (—á–µ—Ä–µ–∑ checkStatus).
   * 2. –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏–∑—Ä–∞–∫–∞ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –±—É–∫–≤—É –∏–∑ –µ–≥–æ –∏–º–µ–Ω–∏.
   * 3. –ï—Å–ª–∏ –∫–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ —É—Å–ø–µ—Ö–µ –≤ –¥–Ω–µ–≤–Ω–∏–∫ (—Å —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ),
   *    –∏–Ω–∞—á–µ ‚Äì –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ –Ω–µ—É–¥–∞—á–µ.
   * 4. –£–¥–∞–ª—è–µ—Ç —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–≤–µ—Å—Ç–∞ (mirrorQuestActive) –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
   *
   * @returns {Promise<void>}
   */
  async finish() {
    // –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —É—Å–ª–æ–≤–∏–π –∫–≤–µ—Å—Ç–∞.
    const success = await this.checkStatus();
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏–∑—Ä–∞–∫–∞ –∏ —Å–ª—É—á–∞–π–Ω—É—é –±—É–∫–≤—É –∏–∑ –µ–≥–æ –∏–º–µ–Ω–∏.
    const ghost = this.app.ghostManager.getCurrentGhost();
    const randomLetter = this.getRandomLetter(ghost.name);

    if (success) {
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –æ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ.
      const photoData = this.app.lastMirrorPhoto ? ` [photo attached]\n${this.app.lastMirrorPhoto}` : "";
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–≤–µ—Å—Ç–∞ –≤ –¥–Ω–µ–≤–Ω–∏–∫, —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º (–±—É–∫–≤–∞ –∏, –≤–æ–∑–º–æ–∂–Ω–æ, —Ñ–æ—Ç–æ).
      await this.eventManager.addDiaryEntry(`user_post_success: ${randomLetter}${photoData}`, false);
      alert("‚úÖ –ó–∞–¥–∞–Ω–∏–µ ¬´–ø–æ–¥–æ–π—Ç–∏ –∫ –∑–µ—Ä–∫–∞–ª—É¬ª –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!");
    } else {
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –Ω–µ—É–¥–∞—á–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–≤–µ—Å—Ç–∞.
      await this.eventManager.addDiaryEntry(`user_post_failed: ${randomLetter}`, false);
      alert("‚ùå –ö–≤–µ—Å—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω!");
    }

    // –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–≤–µ—Å—Ç–∞, —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–∏–ª—Å—è.
    localStorage.removeItem("mirrorQuestActive");
    this.app.updatePostButtonState();

    // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (—É–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å "glowing" —Å –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã).
    const cameraBtn = document.getElementById("toggle-camera");
    if (cameraBtn) {
      cameraBtn.classList.remove("glowing");
    }
  }

  /**
   * getRandomLetter ‚Äì –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –±—É–∫–≤—É –∏–∑ —Å—Ç—Ä–æ–∫–∏.
   *
   * –ú–µ—Ç–æ–¥ –æ—á–∏—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –æ—Ç —Å–∏–º–≤–æ–ª–æ–≤, –æ—Ç–ª–∏—á–Ω—ã—Ö –æ—Ç –±—É–∫–≤ (–ª–∞—Ç–∏–Ω—Å–∫–∏—Ö –∏ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏—Ö),
   * –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Å–∏–º–≤–æ–ª –∏–∑ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –Ω–∞–±–æ—Ä–∞.
   *
   * @param {string} name - –°—Ç—Ä–æ–∫–∞, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –±—É–∫–≤–∞.
   * @returns {string} –°–ª—É—á–∞–π–Ω–∞—è –±—É–∫–≤–∞ –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, –µ—Å–ª–∏ –±—É–∫–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
   */
  getRandomLetter(name) {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ –±—É–∫–≤.
    const letters = name.replace(/[^A-Za-z–ê-–Ø–∞-—è–Å—ë]/g, '').split('');
    if (letters.length === 0) return '';
    const randomIndex = Math.floor(Math.random() * letters.length);
    return letters[randomIndex];
  }
}